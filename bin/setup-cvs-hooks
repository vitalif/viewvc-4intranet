#!/bin/sh

CVSROOT=$1
VIEWVC_DIR=$2
CVS_USER=$3
CVS_CRONJOB=$4

if [ ! "$CVSROOT" -o ! "$VIEWVC_DIR" -o ! "$CVS_USER" ]; then
    echo "USAGE: $0 <CVSROOT> <VIEWVC_DIR> <CVS_USER> [CVS_CRONJOB]"
    exit
fi

echo "*** Setting up commit hook for CVS (job=$CVS_CRONJOB)"
if [ "$CVS_CRONJOB" ]; then
    VHOOK="touch $VIEWVC_DIR/.cvs-updated"
else
    VHOOK="$VIEWVC_DIR/bin/cvsdbadmin update $CVSROOT >/dev/null"
fi;
su $CVS_USER -s /bin/sh <<EOSH
CVSROOT=$CVSROOT cvs co CVSROOT
if [ ! $? ]; then
cd CVSROOT
mv loginfo loginfo.bak
grep -v '/.cvs-updated' <loginfo.bak | grep -v '/bin/cvsdbadmin update' >loginfo
cat >>loginfo <<EOF
* $VHOOK
EOF
chmod 755 loginfo
cvs ci -m 'CVS commit hook for ViewVC' loginfo
fi
EOSH
if [ "$CVS_CRONJOB" ]; then
    cat >$VIEWVC_DIR/cvshook <<EOF
#!/bin/sh
if [ -e "$VIEWVC_DIR/.cvs-updated" ]; then
    rm "$VIEWVC_DIR/.cvs-updated"
    $VIEWVC_DIR/bin/cvsdbadmin update $CVSROOT >/dev/null
fi
EOF
    chmod 755 $VIEWVC_DIR/cvshook
    cat >/etc/cron.d/viewvc-cvs-$CVS_CRONJOB <<EOF
*/5 * * * * $VIEWVC_DIR/cvshook
EOF
    /etc/init.d/cron reload
fi

